<!DOCTYPE HTML>
<html>
    <head>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="js/rainbowvis.js" type="text/javascript"></script>

	<script type='text/javascript'>
	 var little_endianness = false;
	 var max_intensity = 4095;
	 
	 // Globals
	 var inf = {};
	 var dax = {};
	 var foo;

	 // File readers
	 function loadMultipleFiles(id) {
             var input = document.getElementById(id);

	     for(var i = 0; i < input.files.length; i++) {
		 var file = input.files[i];
		 console.log(file);
		 loadFile(file);
	     }

	 }
	 function loadFile(file) {
	     var filename = file.name.split('.');
	     var ext = filename.pop();
	     filename = filename.join('_');

	     if(ext == 'inf') {
		 loadInfFile(file, filename);
	     } else if(ext == 'dax') {
		 if( inf[filename] === undefined ) {
		     alert("Corresponding .inf file for " + filename + " must be uploaded first");
		 } else {
		     loadDaxFile(file, filename);
		 }
	     } else {
		 alert("Unrecognized file extension: " + ext);
	     }
	 }
	 function loadInfFile(file, filename) {
             var fr = new FileReader();
             fr.onload = processInf;
             fr.readAsText(file);

             function processInf() {
		 parseInf(fr, filename);
             }
	 }
	 function loadDaxFile(file, filename) {
	     little_endianness = document.getElementById('little_endianness').checked
	     max_intesnity = parseInt(document.getElementById('max_intensity').value)	     

	     var fr = new FileReader();
	     fr.onload = processDax
	     fr.readAsArrayBuffer(file);

             function processDax() {
		 parseDax(fr, filename);
             }
	 }

	 // File parsers
	 function parseInf(fr, filename) {
             var result = fr.result.split(/\n/);
             // parse into dictionary
             var dict = new Object();
             dict[result[0].trim()] = result[1].trim();
             for(var i = 2; i < (result.length-1); i++) {
		 var resulti = result[i].split('=');
		 dict[resulti[0].trim()] = resulti[1].trim();
             }
             // set global
             inf[filename] = dict;
	     // Record
	     record('loadedInfFiles', filename); 
	 }
	 function parseDax(fr, filename) {
             var markup, result, n, aByte, byteStr, data;

	     foo = fr.result
	     
	     // complicated way to read both big endian and little endian binary data
	     var data = new DataView(fr.result)
	     var tempArray = new Uint16Array(data.byteLength / Uint16Array.BYTES_PER_ELEMENT);
	     var len = tempArray.length;
	     for (var jj = 0; jj < len; ++jj) {
		 tempArray[jj] = data.getUint16(jj * Uint16Array.BYTES_PER_ELEMENT, little_endianness); 
	     }
	     
	     // set global
	     dax[filename] = tempArray;
	     
	     // Record
	     record('loadedDaxFiles', filename); 
	 }

	 // Record
	 function record(id, filename) {
	     document.getElementById(id).insertAdjacentHTML('beforeend', '<div><form class="form-inline"><input class="form-check-input draw_upload" type="checkbox" id=' + filename + ' value=' + filename + '><label class="form-check-label" for=' + filename + '><span class="btn">' + filename + '</span></label><a href="#" class="delete_upload"><button class="btn btn-danger">remove</button></a></form></div>');
	 }
	 $(document).ready(function() {
	     $('body').on('click', '.delete_upload', function() {
		 console.log('removing');
		 $(this).closest('div').remove();
		 
		 // need to actually remove content, not just checkbox
		 return false;
	     });
	 });

	 // Draw
	 function drawCanvas(filename) {
	     var dim = inf[filename]['frame dimensions'].split('x')
	     var numCol = parseInt(dim[0])
	     var numRow = parseInt(dim[1])
	     var numPixels = numRow*numCol
	     var pixelData = dax[filename]
	     
	     // set up canvas
	     var imageCanvas = document.getElementById('canvas');
	     imageCanvas.setAttribute("width", numCol);
	     imageCanvas.setAttribute("height", numRow);
	     var context = imageCanvas.getContext('2d');
	     
	     var imageData = context.getImageData(0, 0, numCol, numRow); 	     
	     // fill with our pixel data, convert to rgb
	     for(var i = 0; i < numPixels; i++) {
		 imageData.data[4*i] = (pixelData[i]*255)/max_intensity; // red
		 imageData.data[4*i+1] = (pixelData[i]*255)/max_intensity; // green
		 imageData.data[4*i+2] = (pixelData[i]*255)/max_intensity; // blue
		 imageData.data[4*i+3] = 255; // alpha
	     }
	     context.putImageData(imageData, 0, 0);
	     initZoom();
	 }

	</script>


	<script>
	 // Based on tutorial from Gavin Kistner: http://phrogz.net/tmp/canvas_zoom_to_cursor.html
	 function initZoom() {
	     var canvas = document.getElementById('canvas');

	     var gkhead = new Image;
	     gkhead.src = canvas.toDataURL();

	     var ctx = canvas.getContext('2d');
	     trackTransforms(ctx);

	     function redraw(){
		 
		 // Clear the entire canvas
		 var p1 = ctx.transformedPoint(0,0);
		 var p2 = ctx.transformedPoint(canvas.width,canvas.height);
		 ctx.clearRect(p1.x,p1.y,p2.x-p1.x,p2.y-p1.y);
		 
		 ctx.save();
		 ctx.setTransform(1,0,0,1,0,0);
		 ctx.clearRect(0,0,canvas.width,canvas.height);
		 ctx.restore();

		 ctx.drawImage(gkhead,0,0);

	     }
	     redraw();

	     var lastX=canvas.width/2, lastY=canvas.height/2;

	     var dragStart,dragged;

	     canvas.addEventListener('mousedown',function(evt){
		 document.body.style.mozUserSelect = document.body.style.webkitUserSelect = document.body.style.userSelect = 'none';
		 lastX = evt.offsetX || (evt.pageX - canvas.offsetLeft);
		 lastY = evt.offsetY || (evt.pageY - canvas.offsetTop);
		 dragStart = ctx.transformedPoint(lastX,lastY);
		 dragged = false;
	     },false);

	     canvas.addEventListener('mousemove',function(evt){
		 lastX = evt.offsetX || (evt.pageX - canvas.offsetLeft);
		 lastY = evt.offsetY || (evt.pageY - canvas.offsetTop);
		 dragged = true;
		 if (dragStart){
		     var pt = ctx.transformedPoint(lastX,lastY);
		     ctx.translate(pt.x-dragStart.x,pt.y-dragStart.y);
		     redraw();
		 }
	     },false);

	     canvas.addEventListener('mouseup',function(evt){
		 dragStart = null;
		 if (!dragged) zoom(evt.shiftKey ? -1 : 1 );
	     },false);

	     var scaleFactor = 1.1;

	     var zoom = function(clicks){
		 var pt = ctx.transformedPoint(lastX,lastY);
		 ctx.translate(pt.x,pt.y);
		 var factor = Math.pow(scaleFactor,clicks);
		 ctx.scale(factor,factor);
		 ctx.translate(-pt.x,-pt.y);
		 redraw();
	     }

	     var handleScroll = function(evt){
		 var delta = evt.wheelDelta ? evt.wheelDelta/40 : evt.detail ? -evt.detail : 0;
		 if (delta) zoom(delta);
		 return evt.preventDefault() && false;
	     };

	     canvas.addEventListener('DOMMouseScroll',handleScroll,false);
	     canvas.addEventListener('mousewheel',handleScroll,false);

	 }
	 
 	 // Adds ctx.getTransform() - returns an SVGMatrix
	 // Adds ctx.transformedPoint(x,y) - returns an SVGPoint
	 function trackTransforms(ctx){
	     var svg = document.createElementNS("http://www.w3.org/2000/svg",'svg');
	     var xform = svg.createSVGMatrix();
	     ctx.getTransform = function(){ return xform; };

	     var savedTransforms = [];
	     var save = ctx.save;
	     ctx.save = function(){
		 savedTransforms.push(xform.translate(0,0));
		 return save.call(ctx);
	     };

	     var restore = ctx.restore;
	     ctx.restore = function(){
		 xform = savedTransforms.pop();
		 return restore.call(ctx);
	     };

	     var scale = ctx.scale;
	     ctx.scale = function(sx,sy){
		 xform = xform.scaleNonUniform(sx,sy);
		 return scale.call(ctx,sx,sy);
	     };

	     var rotate = ctx.rotate;
	     ctx.rotate = function(radians){
		 xform = xform.rotate(radians*180/Math.PI);
		 return rotate.call(ctx,radians);
	     };

	     var translate = ctx.translate;
	     ctx.translate = function(dx,dy){
		 xform = xform.translate(dx,dy);
		 return translate.call(ctx,dx,dy);
	     };

	     var transform = ctx.transform;
	     ctx.transform = function(a,b,c,d,e,f){
		 var m2 = svg.createSVGMatrix();
		 m2.a=a; m2.b=b; m2.c=c; m2.d=d; m2.e=e; m2.f=f;
		 xform = xform.multiply(m2);
		 return transform.call(ctx,a,b,c,d,e,f);
	     };

	     var setTransform = ctx.setTransform;
	     ctx.setTransform = function(a,b,c,d,e,f){
		 xform.a = a;
		 xform.b = b;
		 xform.c = c;
		 xform.d = d;
		 xform.e = e;
		 xform.f = f;
		 return setTransform.call(ctx,a,b,c,d,e,f);
	     };

	     var pt  = svg.createSVGPoint();
	     ctx.transformedPoint = function(x,y){
		 pt.x=x; pt.y=y;
		 return pt.matrixTransform(xform.inverse());
	     }
	 }
	</script>

    </head>
    <body>
	<nav class="navbar navbar-dark bg-dark">
	    <a class="navbar-brand" href="#">MERmaid - a MERFISH data viewer</a>
	</nav>

	<br>
	
	<div class="container-fluid">	    
	    <div class="row">
		<div class="col">   
		    <form>
			<input class="form-control" type='file' id='fileinput' multiple>
			<br>
			<input class="btn btn-block btn-secondary" type='button' id='btnLoad' value='Load' onclick='loadMultipleFiles("fileinput")'>
		    </form>

		    <hr>
		    
		    <form class="form-inline">
			<input type="checkbox" class="form-check-input" id="little_endianness">
			<label class="form-check-label" for="little_endianess">Little Endian? Check if true. Unclear how to set automatically...</label>
		    </form>
		    <form class="form-inline">
			<label for="max_intensity">Max Intensity (number). Unclear how to set automatically...</label>
			<input class="form-control" id="max_intensity" value=4095>
		    </form>
		    
		</div>
	    </div>
	    <hr>
	    <div class="row">
		<div class="col">
		    <div class="card">
			<div class="card-header">Inf Files</div>
			<div class="card-body" id="loadedInfFiles">
			</div>
		    </div>
		</div>
		<div class="col">
		    <div class="card">
			<div class="card-header">Dax Files</div>
			<div class="card-body" id="loadedDaxFiles">
			</div>
		    </div>
		</div>
		<div class="col">
		    <div class="card">
			<div class="card-header">Tif Files</div>
			<div class="card-body" id="loadedTifFiles">
			</div>
		    </div>
		</div>
		<div class="col">
		    <div class="card">
			<div class="card-header">Bin Files</div>
			<div class="card-body" id="loadedBinFiles">
			</div>
		    </div>
		</div>
	    </div>
	    <br>
	    <div class="row">
		<div class="col">   
		    <input class="btn btn-secondary btn-block" type='button' id='btnDraw' value='Draw' onclick='drawCanvas($(".draw_upload:checkbox:checked")[0].id)'>
		</div>
	    </div>
	</div>
	<div class="row">
	    <div class="col">
		<canvas id="canvas"></canvas>
	    </div>
	</div>
    </body>
</html>
