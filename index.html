<!DOCTYPE HTML>
<html>
    <head>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="js/math.js" type="text/javascript"></script>
	<script src="js/rainbowvis.js" type="text/javascript"></script>

	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script src="https://code.highcharts.com/modules/heatmap.js"></script>
	<script src="https://code.highcharts.com/modules/exporting.js"></script>
	<script src="https://code.highcharts.com/modules/data.js"></script>
	<script src="https://code.highcharts.com/modules/boost-canvas.js"></script>
	<script src="https://code.highcharts.com/modules/boost.js"></script>

	<script type='text/javascript'>
	 var little_endianness = true;
	 
	 // Globals
	 var inf = {};
	 var dax = {};
	 var foo;

	 // File readers
	 function loadMultipleFiles(id) {
             var input = document.getElementById(id);

	     for(var i = 0; i < input.files.length; i++) {
		 var file = input.files[i];
		 console.log(file);
		 loadFile(file);
	     }

	 }
	 function loadFile(file) {
	     var filename = file.name.split('.');
	     var ext = filename.pop();
	     filename = filename.join('_');

	     if(ext == 'inf') {
		 loadInfFile(file, filename);
	     } else if(ext == 'dax') {
		 if( inf[filename] === undefined ) {
		     alert("Corresponding .inf file for " + filename + " must be uploaded first");
		 } else {
		     loadDaxFile(file, filename);
		 }
	     } else {
		 alert("Unrecognized file extension: " + ext);
	     }
	 }
	 function loadInfFile(file, filename) {
             var fr = new FileReader();
             fr.onload = processInf;
             fr.readAsText(file);

             function processInf() {
		 parseInf(fr, filename);
             }
	 }
	 function loadDaxFile(file, filename) {
	     var fr = new FileReader();
	     fr.onload = processDax
	     fr.readAsArrayBuffer(file);

             function processDax() {
		 parseDax(fr, filename);
             }
	 }

	 // File parsers
	 function parseInf(fr, filename) {
             var result = fr.result.split(/\n/);
             // parse into dictionary
             var dict = new Object();
             dict[result[0].trim()] = result[1].trim();
             for(var i = 2; i < (result.length-1); i++) {
		 var resulti = result[i].split('=');
		 dict[resulti[0].trim()] = resulti[1].trim();
             }
             // set global
             inf[filename] = dict;
	     // Record
	     record('loadedInfFiles', filename); 
	 }
	 function parseDax(fr, filename) {
             var markup, result, n, aByte, byteStr, data;

	     foo = fr.result
	     
	     // complicated way to read both big endian and little endian binary data
	     var data = new DataView(fr.result)
	     var tempArray = new Uint16Array(data.byteLength / Uint16Array.BYTES_PER_ELEMENT);
	     var len = tempArray.length;
	     for (var jj = 0; jj < len; ++jj) {
		 tempArray[jj] = data.getUint16(jj * Uint16Array.BYTES_PER_ELEMENT, little_endianness); 
	     }
	     
	     // set global
	     dax[filename] = tempArray;
	     
	     // Record
	     record('loadedDaxFiles', filename); 
	 }

	 // Record
	 function record(id, filename) {
	     document.getElementById(id).insertAdjacentHTML('beforeend', '<div><input type="checkbox" id=' + filename + ' value=' + filename + '><label for=' + filename + '>' + filename + ' </label><a href="#" class="delete_upload">(remove)</a></div>');
	 }
	 $(document).ready(function() {
	     $('body').on('click', '.delete_upload', function() {
		 console.log('removing');
		 $(this).closest('div').remove();
		 
		 // need to actually remove content, not just checkbox
		 return false;
	     });
	 });

	 // Draw
	 function drawCanvas(filename) {
	     var dim = inf[filename]['frame dimensions'].split('x')
	     var numCol = parseInt(dim[0])
	     var numRow = parseInt(dim[1])
	     var numPixels = numRow*numCol
	     var pixelData = dax[filename]
	     
	     // set up canvas
	     var imageCanvas = document.getElementById('glCanvas');
	     imageCanvas.setAttribute("width", numCol);
	     imageCanvas.setAttribute("height", numRow);
	     var ctx = imageCanvas.getContext('2d');
	     var imageData = ctx.getImageData(0, 0, imageCanvas.width, imageCanvas.height); 
	     
	     // convert to rgb
	     for(var i = 0; i < numPixels; i++) {
		 imageData.data[4*i] = (pixelData[i]*255)/4095; // red
		 imageData.data[4*i+1] = (pixelData[i]*255)/4095; // green
		 imageData.data[4*i+2] = (pixelData[i]*255)/4095; // blue
		 imageData.data[4*i+3] = 255; // alpha
	     }

	     ctx.putImageData(imageData, 0, 0);	     
	 } 	     

	</script>


    </head>
    <body>

	<form action='#' onsubmit="return false;">
	    <input type='file' id='fileinput' multiple>
	    <input type='button' id='btnLoad' value='Load' onclick='loadMultipleFiles("fileinput")'>
	</form>
	
	<br>
	<br>

	<div id="loadedInfFiles">Inf Files:
	</div>
	<div id="loadedDaxFiles">Dax Files:
	</div>
	
	<br>
	<br>

	<input type='button' id='btnDraw' value='Draw' onclick='drawCanvas(document.querySelectorAll("input:checked")[0].value)'>
	<br>

	<canvas id="glCanvas" width="640" height="480"></canvas>

    </body>
</html>
