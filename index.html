<html>
    <head>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
	<script type="text/javascript" src="//stardustjs.github.io/stardust/v0.1.1/stardust.bundle.min.js"></script>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>	 
	
    </head>

    <body>
	<div class="container-fluid">
	    <div class="row">
		<nav id="sidebar" class="col-md-2 sidebar">
		    <div class="sidebar-sticky p-2"> 
			<div id='data'>
			</div>

			<div id='viewport' class="form-group">
			    <label for="scale">Scale</label>
			    <input type="range" min="1" max="4" step="0.01" value="1" class="slider" id="scale" onchange="zoom()">

			    <label for="xshift">X-Shift</label>
			    <input type="range" min="-100" max="100" step="0.01" value="0" class="slider" id="xshift" onchange="zoom()">

			    <label for="yshift">Y-Shift</label>
			    <input type="range" min="-100" max="100" step="0.01" value="0" class="slider" id="yshift" onchange="zoom()">
			</div>
		    </div>
		</nav>

		<main class="col-md-10 m0 p0">
		    <canvas id="main-canvas" style='border:1px solid black' width=1000 height=1000>
		    </canvas>
		</main>
	    </div>
	</div>
    </body>

    <script>
     
     $(document).ready(function() {
	 $.ajax({
	     type: "GET",
	     url: "data1.csv",
	     dataType: "text",
	     success: function(data) {
		 console.log('Loading data ...');
		 processData(data);
	     }
	 });
     });

     // globals
     var points = []; 
     var features = []; // names of features that are not x, y, z position
     var featureOptions = []; // feature options
     
     var xMin;
     var xMax;
     var yMin;
     var yMax;
     
     function processData(text) {
	 console.log('Processing data ...');
	 
	 var lines = text.split('\n');
	 var colnames = lines[0].split(',');
	 
	 function toObject(arr) {
	     var rv = {};
	     for (var i = 0; i < arr.length; ++i)
		 rv[colnames[i]] = arr[i];
	     return rv;
	 }
	 
	 for(var i = 1; i < lines.length-1; i++) {
	     // test process few lines
	     //for(var i = 1; i < 1000; i++) {
	     var res = toObject(lines[i].split(','));
	     res.x = Number(res.x);
	     res.y = Number(res.y);
	     points.push(res);
	 }

	 var x = points.map(function(value) {
	     return value.x;
	 });
	 var y = points.map(function(value) {
	     return value.y;
	 });
	 function myMin(foo) {
    	     var r = foo[0];
    	     foo.forEach(function(v,i,a){if (v<r) r=v;});
    	     return r;
	 };
	 function myMax(foo) {
    	     var r = foo[0];
    	     foo.forEach(function(v,i,a){if (v>r) r=v;});
    	     return r;
	 };
	 xMin = myMin(x);
	 xMax = myMax(x);
	 yMin = myMin(y);
	 yMax = myMax(y);

	 getFeatures();
	 drawTable()
	 draw();
     }

     // After data has been processed, can draw features
     function getFeatures() {
	 console.log('Getting data features ...');
	 
	 var colnames = Object.keys(points[1]);
	 features = colnames.filter(x => !['x', 'y', 'z'].includes(x));
	 $.each(features, function(i, f) {
	     var a = [];
	     // Use subset to make faster
	     $.each(points, function(j, x) {
		 a.push(x[f])
	     });
	     var unique = a.filter(function(item, k, ar){ return ar.indexOf(item) === k; });
	     featureOptions[f] = unique.sort();
	 })
     };
     function drawTable() {
	 console.log('Drawing tables ...');
	 
	 var tblRow = ""
	 $.each(features, function(i, f) {
	     tblRow = tblRow + "<b>"+f+"</b> <select id = \"" + f + "\" onchange=\"getSelected(\'"+f+"\')\">"

	     $.each(featureOptions[f], function(j, x) {
		 tblRow = tblRow + "<option value='" + x + "'>" + x + "</option>"
	     });

	     tblRow = tblRow + "</select><br><br>"
	 });
	 $(tblRow).appendTo("#data");
     };
     
     
     // Draw genes

     var canvas = document.getElementById("main-canvas");
     var width  = $("main").width();
     var height = window.innerHeight;
     canvas.width = width;
     canvas.height = height;
     var platform = Stardust.platform("webgl-2d", canvas, width, height);
     var circle = new Stardust.mark.circle(16);

     var scale = 1;
     var xShift = 0;
     var yShift = 0;

     var genePoints = [];
     function setGene(gene) {
     	 genePoints = []; //reset
         for(var i = 0; i < points.length; i++) {
             if(points[i].gene == gene) {
                 genePoints.push(points[i])
             }
         }
     }

     function draw() {
         
         var circles = Stardust.mark.create(circle, platform);
	 var xc = (xMin + xMax)/2; // origin x
	 var yc = (yMin + yMax)/2; // origin y
         
         var scaleX = Stardust.scale.linear()
			      .domain([(xMin-xc)/scale + xc + xShift, (xMax-xc)/scale + xc + xShift])
			      .range([ 0, width ]);
         var scaleY = Stardust.scale.linear()
			      .domain([(yMin-yc)/scale + yc - yShift, (yMax-yc)/scale + yc - yShift])
			      .range([ 0, height ]);
         circles.attr("center", Stardust.scale.Vector2(scaleX(d => d.x), scaleY(d => d.y)));
         circles.attr("radius", scale);
         circles.attr("color", [ 1, 1, 1, 0.4 ]);
         circles.data(points);
         
         var circles2 = Stardust.mark.create(circle, platform);
         circles2.attr("center", Stardust.scale.Vector2(scaleX(d => d.x), scaleY(d => d.y)));
         circles2.attr("radius", scale*4);
         circles2.attr("color", [ 1, 0, 0, 1 ]);
         circles2.data(genePoints);

         platform.clear([ 0, 0, 0, 1 ]);
         circles.render();
         circles2.render();

     };

     function zoom() {
     	 var e = document.getElementById('scale');
	 var strSel = e.value;
	 console.log(strSel)
	 scale = Number(strSel);

     	 var e = document.getElementById('xshift');
	 var strSel = e.value;
	 console.log(strSel)
	 xShift = Number(strSel);

     	 var e = document.getElementById('yshift');
	 var strSel = e.value;
	 console.log(strSel)
	 yShift = Number(strSel);

	 var e = document.getElementById('gene');
	 var strSel = e.options[e.selectedIndex].value;
	 console.log(strSel)
	 setGene(strSel)

	 draw();	
     }

     function getSelected(el) {
	 var e = document.getElementById(el);
	 var strSel = e.options[e.selectedIndex].value;
	 console.log(strSel)
	 setGene(strSel)
	 
	 draw();	 
     }


     // resize the canvas to fill browser window dynamically
     window.addEventListener('resize', resizeCanvas, false);
     function resizeCanvas() {
         width = $("main").width();
         height = window.innerHeight;
         canvas.width = width;
     	 canvas.height = height;
         platform = Stardust.platform("webgl-2d", canvas, width, height);
         zoom();
     }
     resizeCanvas();
     
    </script>

</html>
